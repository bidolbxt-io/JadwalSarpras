<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            
            // LINK APPS SCRIPT BOS (Sudah saya pasang disini)
            const API_URL = "https://script.google.com/macros/s/AKfycbwwXWZmmBhVuOlhgJXzltB7Zzn96hN_XkLE8QjUyow3YHDWUSBFzc-D48tWfDq6Mmj0/exec"; 
            
            // Settingan Cache (Agar tidak loading terus)
            const CACHE_KEY = 'jadwal_gor_data';
            const CACHE_TIME = 15 * 60 * 1000; // 15 Menit (dalam milidetik)

            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'id',
                height: 'auto',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,listMonth'
                },
                buttonText: {
                    today: 'Hari Ini',
                    month: 'Bulan',
                    list: 'Daftar'
                },
                
                // LOGIKA PENGAMBILAN DATA (SMART CACHE)
                events: function(info, successCallback, failureCallback) {
                    
                    // 1. Cek apakah ada data tersimpan di HP?
                    const cachedData = localStorage.getItem(CACHE_KEY);
                    const cachedTime = localStorage.getItem(CACHE_KEY + '_time');
                    const now = new Date().getTime();

                    // 2. Jika ada data & belum kadaluarsa (masih < 15 menit)
                    if (cachedData && cachedTime && (now - cachedTime < CACHE_TIME)) {
                        console.log("Mengambil data dari Cache (Ngebut!) âš¡");
                        successCallback(JSON.parse(cachedData));
                        calendarEl.style.opacity = 1;
                        return; // Stop, tidak perlu lapor ke server
                    }

                    // 3. Jika tidak ada cache, baru minta ke Server
                    console.log("Data lama/kosong. Mengambil dari Server... ðŸ¢");
                    calendarEl.style.opacity = 0.5; // Efek loading

                    fetch(API_URL)
                    .then(response => response.json())
                    .then(data => {
                        // Simpan data baru ke HP Warga
                        localStorage.setItem(CACHE_KEY, JSON.stringify(data));
                        localStorage.setItem(CACHE_KEY + '_time', now);
                        
                        calendarEl.style.opacity = 1;
                        successCallback(data);
                    })
                    .catch(error => {
                        console.error('Gagal ambil data:', error);
                        
                        // Fallback: Kalau server error, coba tampilkan data lama (kalau ada)
                        if (cachedData) {
                            alert("Koneksi server sibuk. Menampilkan data terakhir yang tersimpan.");
                            successCallback(JSON.parse(cachedData));
                            calendarEl.style.opacity = 1;
                        } else {
                            alert("Gagal memuat jadwal. Mohon periksa koneksi internet Anda.");
                            failureCallback(error);
                        }
                    });
                },

                // SAAT JADWAL DIKLIK
                eventClick: function(info) {
                    alert('Jadwal: ' + info.event.title + '\nJam: ' + info.event.start.toLocaleTimeString());
                }
            });

            calendar.render();
        });
    </script>
